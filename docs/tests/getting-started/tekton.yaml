apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: dagger
spec:
  description: |
    Execute a dagger action from a git repo.
  params:
  - name: dagger-version
    type: string
    description: The dagger version to run.
  - name: dagger-action
    type: string
    description: The dagger action to execute.
  - name: repo-url
    type: string
    description: The git repository URL to clone from.
  - name: app-dir
    type: string
    description: The path to access the app dagger codebase within the repository.
  - name: netlify-site-name
    type: string
    description: The Netlify site name. Unique value among Netlify sites.
  - name: netlify-team
    type: string
    description: The Netlify team to deploy to.
  workspaces:
  - name: shared-data
    description: |
      This workspace will receive the cloned git repo and be passed
      to the next Task.

  tasks:

  - name: fetch-repo
    taskRef:
      name: git-clone
    workspaces:
    - name: output
      workspace: shared-data
    params:
    - name: url
      value: $(params.repo-url)
    - name: revision
      value: $(params.dagger-version)

  - name: dagger-do
    runAfter: ["fetch-repo"]  # Wait until the clone is done before deploying the app.
    workspaces:
    - name: source
      workspace: shared-data
    params:
      - name: dagger-version
        value: $(params.dagger-version)
      - name: dagger-action
        value: $(params.dagger-action)
      - name: app-dir
        value: $(params.app-dir)
      - name: netlify-site-name
        value: $(params.netlify-site-name)
      - name: netlify-team
        value: $(params.netlify-team)
    taskSpec:
      workspaces:
      - name: source
      params:
      - name: dagger-version
      - name: dagger-action
      - name: app-dir
      - name: netlify-site-name
      - name: netlify-team
      steps:
      - image: docker:20.10.13
        name: run-dagger-action
        workingDir: "$(workspaces.source.path)/$(params.app-dir)"
        script: |
          #!/usr/bin/env sh

          # Install dagger
          # Could be removed by using an official muli-arch dagger.io image
          arch=$(uname -m)
          case $arch in
            x86_64) arch="amd64" ;;
            aarch64) arch="arm64" ;;
          esac

          wget -c https://github.com/dagger/dagger/releases/download/$(params.dagger-version)/dagger_$(params.dagger-version)_linux_${arch}.tar.gz  -O - |  \
          tar zxf - -C /usr/local/bin

          dagger version
          dagger do $(params.dagger-action)

        env:
          - name: APP_NAME
            value: $(params.netlify-site-name)
          - name: NETLIFY_TEAM
            value: $(params.netlify-team)
          - name: DAGGER_LOG_FORMAT
            value: plain
          # Get one from https://app.netlify.com/user/applications/personal
          # and save it as a generic kubernetes secret
          - name: NETLIFY_TOKEN
            valueFrom:
              secretKeyRef:
                name: netlify
                key: token
        volumeMounts:
        - mountPath: /var/run/
          name: dind-socket
      sidecars:
        - image: docker:20.10.13-dind
          name: server
          securityContext:
            privileged: true
          volumeMounts:
          - mountPath: /var/run/
            name: dind-socket
      volumes:
      - name: dind-socket
        emptyDir: {}
---
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: deploy-todo-app
spec:
  pipelineRef:
    name: dagger
  workspaces:
  - name: shared-data
    volumeClaimTemplate:
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
  params:
  - name: dagger-version
    value: v0.2.6
  - name: dagger-action
    value: deploy
  - name: repo-url
    value: https://github.com/dagger/dagger.git
  - name: app-dir
    value: pkg/universe.dagger.io/examples/todoapp
  - name: netlify-site-name
    value: mgreau-todoapp-dagger-europa
  - name: netlify-team
    value: mgreau
